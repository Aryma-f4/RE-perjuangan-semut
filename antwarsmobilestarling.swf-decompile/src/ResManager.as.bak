package
{
   import com.boyaa.tool.ForceUpdateGame;
   import com.coltware.airxzip.ZipEntry;
   import com.coltware.airxzip.ZipFileReader;
   import com.freshplanet.ane.AirAlert.AirAlert;
   import flash.events.Event;
   import flash.events.IOErrorEvent;
   import flash.events.ProgressEvent;
   import flash.filesystem.File;
   import flash.filesystem.FileStream;
   import flash.net.URLLoader;
   import flash.net.URLRequest;
   import flash.system.System;
   import flash.text.TextField;
   import flash.text.TextFormat;
   import flash.utils.ByteArray;

   public class ResManager
   {

      public static const CHANGERLOG:String = "ChangerLog.xml";

      private var serverXML:XML;

      private var localXML:XML;

      private var packageXML:XML;

      private var needUpdateFile:Vector.<String>;

      private var needDeleteFile:Vector.<String>;

      private var onProgress:Function;

      private var serverXMLBytes:ByteArray;

      private var completeCount:int = 0;

      private var needComplete:int = 0;

      public var localVersion:int = 0;

      public var serverVersion:int = 0;

      public var packageVersion:int = 0;

      private var _forceUpdate:String = "";

      private var numElements:Number = 0;

      private var currentRatio:Number = 0;

      private var display:TextField;

      public function ResManager()
      {
         super();
      }

      public function update(param1:Function) : void
      {
         var _loc2_:File = null;
         var _loc3_:File = null;
         var _loc6_:FileStream = null;
         var _loc5_:FileStream = null;
         needComplete = 0;
         completeCount = 0;
         localXML = null;
         serverXML = null;
         packageXML = null;
         this.onProgress = param1;
         var _loc4_:URLLoader = new URLLoader();
         _loc4_.dataFormat = "binary";
         _loc4_.addEventListener("ioError",getXMLIoError);
         _loc4_.addEventListener("complete",onUrlLoaderComplete);
         _loc4_.load(new URLRequest(Constants.ResUrl + "/" + "ChangerLog.xml"));
         needComplete = needComplete + 1;
         _loc2_ = File.applicationStorageDirectory.resolvePath("res/ChangerLog.xml");
         _loc3_ = File.applicationDirectory.resolvePath("res/ChangerLog.xml");
         if(_loc2_.exists)
         {
            _loc6_ = new FileStream();
            _loc6_.addEventListener("complete",onFileLoaderComplete);
            _loc6_.openAsync(_loc2_,"read");
            needComplete = needComplete + 1;
         }
         if(_loc3_.exists)
         {
            _loc5_ = new FileStream();
            _loc5_.addEventListener("complete",onFileLoaderComplete2);
            _loc5_.openAsync(_loc3_,"read");
            needComplete = needComplete + 1;
         }
         completeCount = 0;
      }

      private function getXMLIoError(param1:IOErrorEvent) : void
      {
         var _loc2_:URLLoader = param1.target as URLLoader;
         _loc2_.removeEventListener("ioError",getXMLIoError);
         Application.instance.log("IO error: ",param1.text);
         log("xml reader error, please restart the app");
      }

      private function onUrlLoaderComplete(param1:Event) : void
      {
         var _loc2_:URLLoader = param1.target as URLLoader;
         serverXMLBytes = _loc2_.data as ByteArray;
         _loc2_.removeEventListener("complete",onUrlLoaderComplete);
         serverXML = new XML(serverXMLBytes);
         complete();
      }

      private function onFileLoaderComplete(param1:Event) : void
      {
         var _loc3_:FileStream = param1.target as FileStream;
         _loc3_.removeEventListener("complete",onFileLoaderComplete);
         var _loc2_:ByteArray = new ByteArray();
         _loc3_.readBytes(_loc2_);
         localXML = new XML(_loc2_);
         complete();
      }

      private function onFileLoaderComplete2(param1:Event) : void
      {
         var _loc3_:FileStream = param1.target as FileStream;
         _loc3_.removeEventListener("complete",onFileLoaderComplete2);
         var _loc2_:ByteArray = new ByteArray();
         _loc3_.readBytes(_loc2_);
         packageXML = new XML(_loc2_);
         complete();
      }

      private function complete() : void
      {
         var _loc1_:* = null;
         var _loc5_:* = null;
         var _loc3_:String = null;
         var _loc2_:String = null;
         var _loc6_:Array = null;
         var _loc4_:Array = null;
         var _loc7_:int = 0;
         completeCount = completeCount + 1;
         if(completeCount < needComplete)
         {
            return;
         }
         Application.instance.log("changelog.xml路径：",Constants.ResUrl + "/" + "ChangerLog.xml");
         needUpdateFile = new Vector.<String>();
         needDeleteFile = new Vector.<String>();
         if(!localXML)
         {
            localXML = packageXML;
         }
         else
         {
            packageVersion = int(packageXML.version);
            localVersion = int(localXML.version);
            if(packageVersion < localVersion)
            {
               for each(_loc1_ in localXML.changerList)
               {
                  if(int(_loc1_.@version) > packageVersion)
                  {
                     for each(_loc5_ in _loc1_.file)
                     {
                        _loc3_ = _loc5_.toString();
                        if(!File.applicationStorageDirectory.resolvePath("res/" + _loc3_).exists && (_loc3_.indexOf("textures/") == -1 || _loc3_.indexOf(Constants.scaleFactor.toString() + "x/") != -1))
                        {
                           Application.instance.log("ResManager","本地文件丢失需重新加载:" + _loc3_);
                           needUpdateFile.push(_loc3_);
                        }
                     }
                  }
               }
            }
         }
         localVersion = int(localXML.version);
         serverVersion = int(serverXML.version);
         _forceUpdate = String(serverXML.update);
         Application.instance.log("ResManager","当前资源版本:" + localVersion + " 服务器最新版本:" + serverVersion);
         if(_forceUpdate != "" && AirAlert.isSupported)
         {
            _loc2_ = Application.instance.getAppVersionNamber();
            _loc6_ = _forceUpdate.split(".");
            _loc4_ = _loc2_.split(".");
            _loc7_ = 0;
            while(_loc7_ < _loc6_.length)
            {
               if(int(_loc6_[_loc7_]) > int(_loc4_[_loc7_]))
               {
                  Application.instance.log("ResManager","游戏版本不匹配，强制更新游戏，forceUpdate\'s version:" + _forceUpdate);
                  new ForceUpdateGame().show();
                  return;
               }
               _loc7_++;
            }
         }
         if(localVersion < serverVersion)
         {
            for each(_loc1_ in serverXML.changerList)
            {
               if(int(_loc1_.@version) > localVersion)
               {
                  for each(_loc5_ in _loc1_.file)
                  {
                     _loc3_ = _loc5_.toString();
                     if(needUpdateFile.indexOf(_loc3_) == -1 && (_loc3_.indexOf("textures/") == -1 || _loc3_.indexOf(Constants.scaleFactor.toString() + "x/") != -1))
                     {
                        needUpdateFile.push(_loc3_);
                     }
                  }
               }
            }
         }
         serverXML && System.disposeXML(serverXML);
         localXML && System.disposeXML(localXML);
         packageXML && System.disposeXML(packageXML);
         numElements = needUpdateFile.length;
         var _loc8_:int = 0;
         if(numElements > 0)
         {
            currentRatio = 0;
            while(_loc8_ < numElements)
            {
               Application.instance.log("ResManager","加载资源:" + needUpdateFile[_loc8_]);
               loadRaw(needUpdateFile[_loc8_],progress,resume);
               _loc8_++;
            }
         }
         else
         {
            onProgress(1);
         }
      }

      private function loadRaw(param1:String, param2:Function, param3:Function) : void
      {
         var rawName:String = param1;
         var onProgressFun:Function = param2;
         var onComplete:Function = param3;
         var onIoError:* = function(param1:IOErrorEvent):void
         {
            log("net error, please restart the app");
         };
         var onLoadProgress:* = function(param1:ProgressEvent):void
         {
            onProgressFun(param1.bytesLoaded / param1.bytesTotal);
            var _loc2_:String = "..." + int(param1.bytesLoaded / param1.bytesTotal * 100) + "%";
            log(rawName + _loc2_);
         };
         var onUrlLoaderComplete:* = function(param1:Event):void
         {
            var _loc2_:URLLoader = param1.target as URLLoader;
            var _loc3_:ByteArray = _loc2_.data as ByteArray;
            _loc2_.removeEventListener("ioError",onIoError);
            _loc2_.removeEventListener("progress",onLoadProgress);
            _loc2_.removeEventListener("complete",onUrlLoaderComplete);
            saveFile(rawName,_loc3_);
            onComplete();
         };
         var url:String = Constants.ResUrl + "/" + rawName;
         var urlLoader:URLLoader = new URLLoader();
         urlLoader.dataFormat = "binary";
         urlLoader.addEventListener("ioError",onIoError);
         urlLoader.addEventListener("progress",onLoadProgress);
         urlLoader.addEventListener("complete",onUrlLoaderComplete);
         urlLoader.load(new URLRequest(url));
      }

      private function resume() : void
      {
         var _loc1_:File = null;
         var _loc3_:FileStream = null;
         var _loc4_:String = needUpdateFile.pop();
         currentRatio = 1 - needUpdateFile.length / numElements;
         if(onProgress != null)
         {
            onProgress(currentRatio);
         }
         if(currentRatio == 1)
         {
            saveFile("ChangerLog.xml",serverXMLBytes);
            serverXMLBytes = null;
            if(display)
            {
               display.parent.removeChild(display);
            }
            for each(var _loc2_ in needDeleteFile)
            {
               _loc1_ = File.applicationStorageDirectory.resolvePath("res/" + _loc2_);
               _loc3_ = new FileStream();
               _loc3_.open(_loc1_,"write");
               _loc3_.writeBytes(new ByteArray());
               _loc3_.close();
            }
         }
      }

      private function progress(param1:Number) : void
      {
         onProgress(currentRatio + 1 / numElements * Math.min(1,param1) * 0.99);
      }

      private function saveFile(param1:String, param2:ByteArray) : void
      {
         var _loc4_:ZipFileReader = null;
         var _loc9_:Array = null;
         var _loc3_:ByteArray = null;
         trace(param1);
         var _loc5_:File = File.applicationStorageDirectory.resolvePath("res/" + param1);
         _loc5_.parent.createDirectory();
         var _loc8_:FileStream = new FileStream();
         _loc8_.open(_loc5_,"write");
         _loc8_.writeBytes(param2);
         _loc8_.close();
         param2 = null;
         var _loc10_:String = param1.substr(param1.length - 4,4);
         var _loc7_:String = param1.substring(0,param1.lastIndexOf("/") + 1);
         if(_loc10_ == ".zip")
         {
            log("unzip " + param1);
            _loc4_ = new ZipFileReader();
            _loc4_.open(_loc5_);
            _loc9_ = _loc4_.getEntries();
            for each(var _loc6_ in _loc9_)
            {
               if(!_loc6_.isDirectory())
               {
                  _loc3_ = _loc4_.unzip(_loc6_);
                  saveFile(_loc7_ + _loc6_.getFilename(),_loc3_);
               }
            }
            needDeleteFile.push(param1);
            _loc4_.close();
         }
         _loc5_ = null;
      }

      public function getAllResByDir(param1:Array) : Array
      {
         var _loc6_:Array = null;
         var _loc3_:Array = null;
         var _loc8_:int = 0;
         var _loc4_:File = null;
         var _loc7_:int = 0;
         var _loc2_:Array = [];
         var _loc5_:Array = [];
         _loc8_ = 0;
         while(_loc8_ < param1.length)
         {
            trace("res/" + param1[_loc8_]);
            _loc4_ = File.applicationStorageDirectory.resolvePath("res/" + param1[_loc8_]);
            trace(_loc4_.nativePath);
            if(_loc4_.exists)
            {
               _loc6_ = _loc4_.getDirectoryListing();
               _loc7_ = 0;
               while(_loc7_ < _loc6_.length)
               {
                  trace(_loc6_[_loc7_].nativePath);
                  _loc2_.push(_loc6_[_loc7_]);
                  _loc5_.push(File.applicationStorageDirectory.getRelativePath(_loc6_[_loc7_]));
                  _loc7_++;
               }
            }
            _loc4_ = File.applicationDirectory.resolvePath("res/" + param1[_loc8_]);
            if(_loc4_.exists)
            {
               _loc3_ = _loc4_.getDirectoryListing();
               _loc7_ = 0;
               while(_loc7_ < _loc3_.length)
               {
                  if(_loc5_.indexOf(File.applicationDirectory.getRelativePath(_loc3_[_loc7_])) == -1)
                  {
                     _loc2_.push(_loc3_[_loc7_]);
                  }
                  _loc7_++;
               }
            }
            _loc8_++;
         }
         return _loc2_;
      }

      public function getResFile(param1:String) : *
      {
         var _loc2_:File = File.applicationStorageDirectory.resolvePath("res/" + param1);
         if(_loc2_.exists)
         {
            return _loc2_;
         }
         _loc2_ = File.applicationDirectory.resolvePath("res/" + param1);
         if(_loc2_.exists)
         {
            return _loc2_;
         }
         return Constants.ResUrl + "/" + param1;
      }

      private function log(param1:String) : void
      {
         var _loc2_:TextFormat = null;
         if(!display)
         {
            display = new TextField();
            display.textColor = 16777215;
            display.autoSize = "center";
            _loc2_ = new TextFormat();
            _loc2_.size = 22;
            display.defaultTextFormat = _loc2_;
            display.y = (Application.instance.viewPort.height >> 1) + 10;
            Application.instance.currentMain.stage.addChild(display);
         }
         display.text = param1;
         display.x = Application.instance.viewPort.width - 460 >> 1;
      }
   }
}
