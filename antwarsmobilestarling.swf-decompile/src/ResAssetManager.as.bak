package
{
   import com.boyaa.antwars.view.GeneralFactory;
   import dragonBones.Armature;
   import dragonBones.objects.SkeletonData;
   import dragonBones.objects.XMLDataParser;
   import dragonBones.textures.StarlingTextureAtlas;
   import flash.display.Bitmap;
   import flash.display.BitmapData;
   import flash.filesystem.File;
   import flash.filesystem.FileStream;
   import flash.geom.Rectangle;
   import flash.utils.ByteArray;
   import flash.utils.Dictionary;
   import starling.display.DisplayObject;
   import starling.display.Image;
   import starling.text.TextField;
   import starling.textures.Texture;
   import starling.utils.AssetManager;
   import starling.utils.RectangleUtil;

   public class ResAssetManager extends AssetManager
   {

      public static const wqkong:Class = ยงk1_png$d06c51ef224f763e1651a8161784beea-204365992ยง;

      private var mScreenPos:Dictionary;

      private var mBitmapDatas:Dictionary;

      public function ResAssetManager(param1:Number = -1, param2:Boolean = false)
      {
         super(param1,param2);
         mScreenPos = new Dictionary();
         mBitmapDatas = new Dictionary();
         var _loc3_:Bitmap = new wqkong();
         mBitmapDatas["k1"] = _loc3_.bitmapData;
      }

      public function enqueueMap(param1:uint, param2:String) : void
      {
         var _loc3_:String = "res/MAP_SMALL/";
         var _loc5_:File = File.applicationDirectory.resolvePath(_loc3_ + param2 + ".png");
         var _loc4_:File = File.applicationDirectory.resolvePath(_loc3_ + param2 + "_bg.png");
         if(_loc5_.exists && Boolean(_loc4_.exists))
         {
            enqueue(_loc5_,_loc4_);
            return;
         }
         _loc5_ = File.applicationStorageDirectory.resolvePath(_loc3_ + param2 + ".png");
         _loc4_ = File.applicationStorageDirectory.resolvePath(_loc3_ + param2 + "_bg.png");
         if(_loc5_.exists && Boolean(_loc4_.exists))
         {
            enqueue(_loc5_,_loc4_);
            return;
         }
         enqueue(Constants.MapUrl + "/" + param2 + ".png",Constants.MapUrl + "/" + param2 + "_bg.png");
      }

      override protected function saveMap(param1:String, param2:ByteArray) : void
      {
         var _loc4_:FileStream = null;
         var _loc3_:File = File.applicationStorageDirectory.resolvePath("res/MAP_SMALL/" + param1);
         if(!_loc3_.exists)
         {
            _loc3_.parent.createDirectory();
            _loc4_ = new FileStream();
            _loc4_.open(_loc3_,"write");
            _loc4_.writeBytes(param2);
            _loc4_.close();
         }
      }

      override protected function saveFileToRes(param1:String, param2:ByteArray) : void
      {
         var _loc3_:int = 0;
         var _loc4_:File = null;
         var _loc5_:FileStream = null;
         super.saveFileToRes(param1,param2);
         Application.instance.log("saveFileToRes",param1);
         var _loc6_:String = getName(param1);
         if(_loc6_.match(/^map_[0-9]{1,}$/) || _loc6_.match(/^map_[0-9]{1,}_bg$/))
         {
            saveMap(_loc6_ + ".png",param2);
         }
         else
         {
            _loc3_ = int(param1.indexOf("textures"));
            param1 = param1.substr(_loc3_);
            _loc4_ = File.applicationStorageDirectory.resolvePath("res/" + param1);
            if(!_loc4_.exists)
            {
               _loc4_.parent.createDirectory();
               _loc5_ = new FileStream();
               _loc5_.open(_loc4_,"write");
               _loc5_.writeBytes(param2);
               _loc5_.close();
            }
         }
      }

      public function getMapTexture(param1:int, param2:String = "") : Texture
      {
         if(param2.length > 0)
         {
            return getTexture("map_" + param1 + "_" + param2);
         }
         return getTexture("map_" + param1);
      }

      public function removeMapTexture(param1:int, param2:String = "") : void
      {
         if(param2.length > 0)
         {
            removeTexture("map_" + param1 + "_" + param2);
         }
         else
         {
            removeTexture("map_" + param1);
         }
      }

      public function getBitmapData(param1:String) : BitmapData
      {
         return mBitmapDatas[param1] as BitmapData;
      }

      public function getOther(param1:String) : Object
      {
         return getObject(param1);
      }

      public function getGoodsImage(param1:int, param2:int) : Image
      {
         if(param1 == 26)
         {
            if(param2 == 1 || param2 == 2 || param2 == 3)
            {
               param2 = 100 + param2;
            }
         }
         else
         {
            param2 /= 10;
         }
         return getTextureDisplay("part/" + Constants.getGoodsNameById(param1) + "_" + param1 + "_" + param2) as Image;
      }

      public function getGoodsImageByRect(param1:int, param2:int, param3:Rectangle) : Image
      {
         var _loc5_:Rectangle = null;
         var _loc4_:Image = getGoodsImage(param1,param2);
         if(_loc4_)
         {
            _loc4_.pivotX = 0;
            _loc4_.pivotY = 0;
            if(_loc4_.width < param3.width && _loc4_.height < param3.height)
            {
               _loc5_ = RectangleUtil.fit(new Rectangle(0,0,_loc4_.width,_loc4_.height),param3,"none");
            }
            else
            {
               _loc5_ = RectangleUtil.fit(new Rectangle(0,0,_loc4_.width,_loc4_.height),param3,"showAll");
            }
            _loc4_.x = Math.floor(_loc5_.x);
            _loc4_.y = Math.floor(_loc5_.y);
            _loc4_.width = _loc5_.width;
            _loc4_.height = _loc5_.height;
            return _loc4_;
         }
         return null;
      }

      public function getScreenPos(param1:String) : Dictionary
      {
         if(param1 in mScreenPos)
         {
            return mScreenPos[param1] as Dictionary;
         }
         return null;
      }

      public function positionDisplay(param1:DisplayObject, param2:String, param3:String) : void
      {
         var _loc4_:Dictionary = getScreenPos(param2);
         if(_loc4_[param3])
         {
            param1.x = _loc4_[param3].x;
            param1.y = _loc4_[param3].y;
            param1.width = _loc4_[param3].width;
            param1.height = _loc4_[param3].height;
         }
         if(param1 is TextField)
         {
            (param1 as TextField).autoScale = true;
         }
      }

      public function getPosition(param1:String, param2:String) : Rectangle
      {
         var _loc3_:Dictionary = getScreenPos(param1);
         if(_loc3_ && param2 in _loc3_)
         {
            return _loc3_[param2] as Rectangle;
         }
         return null;
      }

      public function removeSkeletons(param1:String) : void
      {
         GeneralFactory.instance.removeSkeleton(param1);
      }

      public function removeBoneAtlases(param1:String) : void
      {
         GeneralFactory.instance.removeBoneAtlas(param1);
      }

      public function removeSkeletonsAndBoneAtlases(param1:String) : void
      {
         GeneralFactory.instance.removeSkeletonAndAtlas(param1);
      }

      public function buildArmature(param1:String) : Armature
      {
         return GeneralFactory.instance.buildArmature(param1);
      }

      public function getTextureDisplay(param1:String, param2:String = null) : Image
      {
         return GeneralFactory.instance.getTextureDisplay(param1,param2);
      }

      override public function addXml(param1:String, param2:XML) : void
      {
         var _loc3_:String = null;
         if(param1.indexOf("ScreensPos") != -1)
         {
            parseScreenPos(param2);
         }
         else if(param1.indexOf("skeleton") != -1)
         {
            _loc3_ = getName(param2.@name.toString());
            addSkeletons(_loc3_,XMLDataParser.parseSkeletonData(param2));
         }
         else
         {
            super.addXml(param1,param2);
         }
      }

      public function addSkeletons(param1:String, param2:SkeletonData) : void
      {
         log("Adding SkeletonData \'" + param1 + "\'");
         if(GeneralFactory.instance.isSkeletonExist(param1))
         {
            throw new Error("Duplicate SkeletonData name: " + param1);
         }
         GeneralFactory.instance.addSkeletonByData(param2);
      }

      override protected function addBoneAtlases(param1:String, param2:StarlingTextureAtlas) : void
      {
         super.addBoneAtlases(param1,param2);
         log("Adding BoneAtlases \'" + param1 + "\'");
         if(GeneralFactory.instance.isBoneAltasExist(param1))
         {
            throw new Error("Duplicate bone texture atlas name: " + param1);
         }
         GeneralFactory.instance.addBoneAtalsByObject(param2);
      }

      override protected function getScaleFactor(param1:String, param2:Number) : Number
      {
         var _loc5_:* = param2;
         var _loc4_:Array = ["hats","prop","charcher_boy","charcher_girl","dragon","worm","spider","zhunhuang","sprite","Leien","LeienSkillEffect","hallAni","weddingOpen","firework","scorpionKind"];
         var _loc3_:Array = ["wedding"];
         if(param1 == "UI_1" || param1 == "UI_2" || param1 == "ui_3" || param1 == "ui4")
         {
            _loc5_ = 0.8 * param2;
         }
         else if(_loc3_.indexOf(param1) != -1)
         {
            _loc5_ = 0.7 * param2;
         }
         else if(_loc4_.indexOf(param1) != -1 || param1.match(/^map_[0-9]{1,}(_bg)?$/))
         {
            _loc5_ = 1;
         }
         return _loc5_;
      }

      override protected function getUseMipMaps(param1:String, param2:Boolean) : Boolean
      {
         return param1 == "hats" || param1 == "charcher_boy" || param1 == "charcher_girl" ? true : param2;
      }

      override protected function disposeBitmap(param1:String, param2:Bitmap) : void
      {
         if(param1.match(/^map_[0-9]{1,}$/) || param1.indexOf("energyLight") != -1)
         {
            mBitmapDatas[param1] = param2.bitmapData;
         }
         else
         {
            param2.bitmapData.dispose();
         }
      }

      private function parseScreenPos(param1:XML) : void
      {
         var _loc4_:String = null;
         var _loc5_:Rectangle = null;
         for each(var _loc2_ in param1.Screen)
         {
            _loc4_ = _loc2_.@name.toString();
            if(!(_loc4_ in mScreenPos))
            {
               mScreenPos[_loc4_] = new Dictionary();
            }
            for each(var _loc3_ in _loc2_..Item)
            {
               _loc5_ = new Rectangle(parseFloat(_loc3_.@x.toString()),parseFloat(_loc3_.@y.toString()),parseFloat(_loc3_.@width.toString()),parseFloat(_loc3_.@height.toString()));
               mScreenPos[_loc4_][_loc3_.@name.toString()] = _loc5_;
            }
         }
      }

      override public function purge() : void
      {
         super.purge();
         for each(var _loc1_ in mBitmapDatas)
         {
            _loc1_.dispose();
         }
         mScreenPos = new Dictionary();
         mBitmapDatas = new Dictionary();
      }
   }
}
